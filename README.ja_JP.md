![test workflow](https://github.com/tos-kamiya/d2vg/workflows/Tests/badge.svg)

**ご注意: 現在devブランチではDBの構造を変更する実験が進行中です。アルファまたはベータのリリースで作成したインデックスDBは、正式リリースでは利用できません。**

# d2vg

d2vgはDoc2Vecによるgrepです（ただし、sentence transformersのモデルも利用します）。

Doc2Vecモデルやsentence transformersのモデルを使って、クエリのフレーズに似た部分を含む文書ファイルを検索します。

* テキストファイル（.txt）、PDFファイル（.pdf）、MS Wordファイル（.docx）からの検索に対応
* インデックス化を行うことで性能向上

## インストール

&rarr; [Ubuntuでのインストール](docs/installation-on-ubuntu.ja_JP.md)  
&rarr; [Windowsでのインストール](docs/installation-on-windows.ja_JP.md)  

デフォルトで、`d2vg`は多言語に対応したsentence transformersモデルを検索に利用します。

## 利用法

```sh
d2vg -v <クエリとなるフレーズ> <ファイル>...
```

検索の実行例:  
![](images/run1.png)

この実行例では、441個の英文のPDFファイルから検索を行っています。メモリ利用量のピークは5.4GiBでした。

### オプション

`d2vg`にはいくつかオプションがあります。よく使われるであろうものを説明します。

`--verbose, -v`  
Verboseオプションです。指定すると、検索の進行中に、その時点までの進捗状況や、最も類似度の高いドキュメントを表示します。

`--model=MODEL, -l MODEL`  
言語に対応したDoc2Vecモデルを選択します。使用可能なモデルは、`en`、`ja`、`ko`、`zh`です。

`--top-n=NUM, -t NUM`  
上位のNUMドキュメントを結果として表示します。既定値は20です。
0を指定すると、検索されたすべての文書を、クエリとの一致度でソートして表示します。

`--paragraph, -p`  
このオプションを指定すると、1つの文書ファイル内のそれぞれのパラグラフがドキュメントとみなされます。検索結果に一つの文書ファイルの複数の段落が出力されるようになります。
このオプションが指定されていない場合、1つの文書ファイルが1つのドキュメントとみなされます。検索結果に一つの文書ファイルはたかだか1回だけ表示されます。

`--window=NUM, -w NUM`  
この数字で指定された行のかたまりを1つの段落として認識します。
既定値は20です。

`--unit-vector, -u`  
クエリとの類似性を計算するとき、文書の分散表現であるベクタを単位ベクトルへと正規化します。パラグラフの長さの差が大きい場合は、短いパラグラフが優先的に検索結果に表示されるようになります。

`--worker=NUM, -j NUM`  
ワーカープロセスの数。0を指定するとCPUコア数と解釈されます。
これにより、特にインデックスが作成されていない文書から検索する場合に、検索速度が向上する可能性があります。

### 言語特化Doc2Vecモデルの利用

デフォルトで、`d2vg`は多言語に対応したsentence transformersモデルを検索に利用します。
オプション`-m`により、特定の言語に特化したモデルを利用した検索を行います。例えば、日本語に特化したモデルを利用するには`-m ja`とします。

デフォルトのモデルと、言語特化モデルとでは、検索結果が異なります。検索に必要なメモリ使用量や時間も異なります。 **現在のバージョンでは、日本語の文書を検索するときには`-m ja`オプションをつけることを推奨します。**

オプション-mにより日本語特化モデルを利用した検索の例  
![](images/run3.png)

(注意) 言語特化Doc2Vecモデルを利用するには、インストール時に「言語特化Doc2Vecモデルのインストール」を行っておく必要があります。
### インクリメンタルなインデックス化

d2vgに文書（検索対象のファイル）のインデックスを作成させることで、同じ文書（の集合）から何度も検索を行う場合に、2回目以降の検索の速度を向上させることができます。

d2vgは以下の条件のときに、インデックスDBを作成して参照します。

* d2vgを実行するときのカレントディレクトリに`.d2vg`というサブディレクトリがある
* 対象の文書ファイルが相対パスで指定されている

インデックス化を開始するには、文書ファイルがあるディレクトリに行って、 `.d2vg` ディレクトリを作成してください。

```sh
cd 文書ファイルのディレクトリ
mkdir .d2vg
```

インデックスDBは検索を行う度にインクリメンタルに更新されます。
すなわち、新しい文書ファイルが追加されて検索の対象になったタイミングで、その文書のインデックスを作成しインデックスDBに追加します。

その一方で、削除された文書ファイルのインデックスをデータベースから自動的に削除する機能は無いので、必要に応じて明示的に`.d2vg`ディレクトリを削除してください。

```sh
cd 文書ファイルのディレクトリ
rm -rf .d2vg
```

DOSプロンプトやPowershellの場合は、それぞれ、`rd /s /q .d2vg`あるいは`rm -r -fo .d2vg`としてください。

インデックス化を有効にしたときの検索の実行例:  
![](images/run4.png)

この例では、インデックス化をしていないときは50秒以上かかっていたものが、5秒ほどに短縮されまた。
### 明示的なインデックス化とインデックス内からの検索

特に、数百万といった個数の文書ファイルを対象とした検索を想定して、明示的にインデックスを作成し、そのインデックス内から検索する方法があります。

明示的なインデックス化により生成されるインデックスDBは、通常のインクリメンタルなインデックス化により作成されるものと全く同じです。
したがって、明示的なインデックスの作成やインデックス内からの検索は、インクリメンタルなインデックス化と混ぜて利用することができます。例えば、インデックスの生成をインクリメンタルなインデックス化により行い、検索はインデックス内から行う、といったことが可能です。

(1) インデックスの作成

このインデックスの作成では、ワーカープロセスの数だけDoc2Vecモデルをロードし、並列にインデックスを生成してインデックスDBに格納していきます。大量のメモリが必要となるので注意してください。

```sh
cd 文書ファイルのディレクトリ
d2vg --update-index -j <ワーカープロセスの数> <ファイル>...
```

インクリメンタルなインデックス化の場合の`-j`オプションは文書ファイルからのテキストの読み出しやトークン化（単語の並びへと変換）の処理を並列化するのに対して、明示的なインデックス化の場合の`-j`オプションは文書ファイルのパースだけではなく、テキストを単語の並び変換する処理も並列化します。

明示的なインデックス化の実行例:  
![](images/run5.png)

(2) インデックス内からの検索

インデックスDBに対して、並列に問い合わせを行います。インデックスDBにない文書ファイルは検索の対象にならず、また、インデックスDBが更新されることもありません。

```sh
cd 文書ファイルのディレクトリ
d2vg -I -j <ワーカープロセスの数> <クエリとなるフレーズ>
```

インデックス内からの検索の実行例。1千万個以上のテキストファイルから6分くらいで検索が完了。  
![](images/run6.png)

(3) インデックス化された文書ファイル一覧

 データベースにインデックスデータが格納されている文書ファイルのリストを出力します。
ファイル数が多い場合は-jオプションを使って並列に実行することをおすすめします。

```sh
cd 文書ファイルのディレクトリ
d2vg --list-indexed -j <ワーカープロセスの数>
```

文書ファイルが大量で、あまり更新されないことがわかっている場合には、明示的なインデックス化を是非利用してください。

## トラブルシューティング

**Q**: d2vgをインストールしようとすると、「pdftotext」がインストールできないというエラーメッセージがでて失敗する。  
**A** pdftotextは、pipコマンドだけではインストールできません。インストールの手順を参照してください。  

**Q**: Doc2Vecモデルをインストールしたのに「`Error: not found Doc2Vec model for language: jp`」というエラーが出ます。  
**A**: 言語の指定が間違っています。「`jp`」ではなく「`ja`」です。

**Q**: d2vgがハングアップします。  
**A**: インデックス化が有効な（ディレクトリ`.d2vg`を作成している）ときに、強制終了すると、次回実行時にインデックスDBが開けなくなってハングアップすることがあるようです。ディレクトリ`.d2vg`を削除してください。

### Doc2Vecモデルの配布ファイル

Doc2Vecモデルは、Gensim v4で作成されたものとしてください。
`<モデル.ref>`というファイル(「モデル」はオプション`-m`で指定するモデル名前です)に、Doc2Vecモデルのファイルへの相対パスを記述してください。

例えば、日本語のDoc2Vecモデルの場合には、`ja.ref`というファイルの中身は`jawiki-janome-m100-c400-d100.model`という行になっています。

```
~/.config/d2vg/models/jawiki-janome-m100-c400-d100
├── ja.ref
├── jawiki-janome-m100-c400-d100.model
└── jawiki-janome-m100-c400-d100.model.dv.vectors.npy
```

## Todo

- [x] ドキュメントファイルのインデックス化の導入による最適化
- [x] 最新版のgensim (gensim v4)と互換性のあるDoc2Vecデータの準備
- [x] Windowsでのインストールを確認
- [x] キーワード検索の併用
- [x] インストールを容易に
- [x] パフォーマンス向上のためのDB構造の変更 (v2)
- [x] 検索対象の文書ファイルが数百万個になったときのための明示的なインデックス化コマンド (v2)
- [x] sentence transformersのモデルの利用 (v2)

## 謝辞

Doc2Vecモデルの作成には次のサイトを参考にしました:  
[日本語Wikipediaで学習したdoc2vecモデル](https://yag-ays.github.io/project/pretrained_doc2vec_wikipedia)

`ko`と`zh`のDoc2Vecモデルの作成は、次のソースを参考にしました:  
https://github.com/Kyubyong/wordvectors/blob/master/build_corpus.py

膨大な言語コーパスを提供されているWikipediaに感謝いたします:  
https://dumps.wikimedia.org/

## ライセンス

d2vgは [BSD-2](https://opensource.org/licenses/BSD-2-Clause) ライセンスで配布されます。
