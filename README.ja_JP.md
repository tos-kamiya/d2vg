![test workflow](https://github.com/tos-kamiya/d2vg/workflows/Tests/badge.svg)

# d2vg

d2vg, A Doc2Vec grep.

Doc2Vecモデルを使って、クエリのフレーズに似た部分を含む文書ファイルを検索します。

* テキストファイル（.txt）、PDFファイル（.pdf）、MS Wordファイル（.docx）からの検索に対応
* 対応言語は日本語、英語。実験的に、中文、韓国語に対応しました。
* インデックス化を行うことで性能向上

## インストール

* &rarr; [Installation on Ubuntu](docs/installation-on-ubuntu.ja_JP.md)
* &rarr; [Installation on Windows](docs/installation-on-windows.ja_JP.md)

中文の場合は、インストールの手順で、次の行の`d2vg[ja]`を`d2vg[zh]`に変更してください。
韓国語の場合は、同様に、`d2vg[ja]`を`d2vg[ko]`に変更してください。

```sh
pip3 install d2vg[ja]
```

## 利用法

```sh
d2vg -v <クエリとなるフレーズ> <ファイル>...
```

英語のドキュメントとして検索する場合には、オプション `-l en` を指定してください:

```sh
d2vg -l en -v <query_phrase> <files>...
```

実行例:  
![](images/example1.png)

### キーワード検索

オプション`-K`をつけると、クエリのフレーズ中に（Doc2Vecモデルの）未知語があった場合は、それらの語をキーワードに指定します。
キーワードが指定された場合は、キーワードがすべて含まれる部分のみが検索結果に表示されます。さらに、指定されたキーワードが「`> keywords:`」という行に表示されます。

実行例: 「CHI」がキーワードに指定された例  
![](images/example3.png)

### インデックス化

d2vgにドキュメント（検索対象のファイル）のインデックスを作成させることで、同じドキュメント（の集合）から何度も検索を行う場合に、2回目以降の検索の速度を向上させることができます。

d2vgは以下の条件のときに、インデックスDBを作成して参照します。

* d2vgを実行するときのカレントディレクトリに`.d2vg`というサブディレクトリがある
* 対象のドキュメントが相対パスで指定されている

インデックス化を開始するには、ドキュメントのディレクトリに行って、 `.d2vg` ディレクトリを作成してください。

```sh
cd ドキュメントのディレクトリ
mkdir .d2vg
```

インデックスDBは検索を行う度にインクリメンタルに更新されます。
すなわち、新しいドキュメントが追加されて検索の対象になったタイミングで、そのドキュメントのインデックスを作成しインデックスDBに追加します。

その一方で、削除されたドキュメントのインデックスをデータベースから自動的に削除する機能は無いので、必要に応じて明示的に`.d2vg`ディレクトリを削除してください。

```sh
cd ドキュメントのディレクトリ
rm -rf .d2vg
```

DOSプロンプトやPowershellの場合は、それぞれ、`rd /s /q .d2vg`あるいは`rm -r -fo .d2vg`としてください。

インデックス化を有効にしたときの実行例:  
(この例では、インデックス化をしていないときは62秒かかっていたものが、4秒に短縮されました。)  
![](images/example2.png)

## トラブルシューティング

**Q**: Doc2Vecモデルをインストールしたのに「`Error: not found Doc2Vec model for language: jp`」というエラーが出ます。  
**A**: 言語の指定が間違っています。「`jp`」ではなく「`ja`」です。

**Q**: d2vgがハングアップします。  
**A**: インデックス化が有効な（ディレクトリ`.d2vg`を作成している）ときに、強制終了すると、次回実行時にインデックスDBが開けなくなってハングアップすることがあるようです。ディレクトリ`.d2vg`を削除してください。

## 開発

Doc2Vecモデルの作成の方法については、`making_doc2vec_model/`にある、英語のDoc2Vecモデルを作成したスクリプトを参考にしてください。
添付しているモデルは、言語によって異なりますが、語彙が4万語から6万5千語であり、100次元のベクトルでドキュメントを表現するものです。
不足していると感じる場合には、スクリプトを利用して、強化したより良いモデルを作成してください。

**協力のお願い**: 特に自分の母国語の日本語以外については、モデルを十分にチューニングできているかどうか自信がありません。モデルの作成に興味を持たれている方、プルリクエスト、作成したモデルを公開しているURL等、大歓迎です。 &#x1f647;

### Doc2Vecモデルの配布ファイル

Doc2Vecモデルは、Gensim v4で作成されたものとしてください。
`<言語.ref>`というファイル(「言語」はオプション`-l`で指定する言語の名前です)に、Doc2Vecモデルのファイルへの相対パスを記述してください。

例えば、日本語のDoc2Vecモデルの場合には、`ja.ref`というファイルの中身は`jawiki-janome-m100-c400-d100.model`という行になっています。

```
~/.config/d2vg/models/jawiki-janome-m100-c400-d100
├── ja.ref
├── jawiki-janome-m100-c400-d100.model
└── jawiki-janome-m100-c400-d100.model.dv.vectors.npy
```

## Todo

- [x] ドキュメントファイルのインデックス化の導入による最適化
- [x] 最新版のgensim v4と互換性のあるDoc2Vecデータの準備
- [x] Windowsでのインストールを確認
- [x] キーワード検索の併用
- [x] インストールを容易に
- [ ] より多くの言語サポートおよびチューニング(実験的サポート: ko, zh)

## 謝辞

Doc2Vecモデルの作成には次のサイトを参考にしました:  
[日本語Wikipediaで学習したdoc2vecモデル](https://yag-ays.github.io/project/pretrained_doc2vec_wikipedia)

`ko`と`zh`のDoc2Vecモデルの作成は、次のソースを参考にしました:  
https://github.com/Kyubyong/wordvectors/blob/master/build_corpus.py

膨大な言語コーパスを提供されているWikipediaに感謝いたします:  
https://dumps.wikimedia.org/

## ライセンス

d2vgは [BSD-2](https://opensource.org/licenses/BSD-2-Clause) ライセンスで配布されます。
